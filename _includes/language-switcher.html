{% assign current_lang = site.data.translations[page.lang] | default: site.data.translations.en %}
<div class="language-switcher" id="languageSwitcher">
  <button id="langToggle" class="btn btn--primary">
    <span class="lang-text">EN/中文</span>
  </button>
</div>

<style>
.language-switcher {
  display: inline-block;
  margin-left: 10px;
}

.language-switcher .btn {
  padding: 0.5rem 0.8rem;
  border-radius: 4px;
  background-color: transparent;
  color: var(--global-masthead-link-color);
  border: none;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 0.9em;
}

.language-switcher .btn:hover {
  color: var(--global-masthead-link-color-hover);
}

/* Hide button style */
.language-switcher.hidden {
  display: none;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const langToggle = document.getElementById('langToggle');
  const langText = langToggle.querySelector('.lang-text');
  const languageSwitcher = document.getElementById('languageSwitcher');
  
  // Get current language from localStorage
  let currentLang = localStorage.getItem('currentLang') || 'en';
  
  // Update button text on load
  updateButtonText();
  
  // Update button text function
  function updateButtonText() {
    langText.textContent = currentLang === 'en' ? 'EN/中文' : '中文/EN';
  }
  
  // Toggle language function
  function toggleLanguage() {
    currentLang = currentLang === 'en' ? 'zh' : 'en';
    localStorage.setItem('currentLang', currentLang);
    updateButtonText();
    
    // Get current page path and URL
    const currentPath = window.location.pathname;
    const currentUrl = window.location.href;
    
    // Instead of redirecting, we'll use an event to notify other scripts
    // that the language has changed
    const event = new CustomEvent('languageChanged', {
      detail: { language: currentLang }
    });
    document.dispatchEvent(event);
    
    // Add language to body class for CSS targeting
    document.body.classList.remove('lang-en', 'lang-zh');
    document.body.classList.add('lang-' + currentLang);
    
    console.log('Language toggled to: ' + currentLang);
    
    // Attempt to find language-specific version if it exists
    // This is a simple implementation - you may need to customize for your site structure
    if (currentLang === 'zh') {
      // Try to find Chinese version
      fetch(currentPath + 'index-zh.html')
        .then(response => {
          if (response.ok) {
            window.location.href = currentPath + 'index-zh.html';
          }
        })
        .catch(err => {
          console.log('No Chinese version found, staying on current page');
        });
    } else {
      // Try to find English version
      if (currentPath.includes('index-zh.html')) {
        window.location.href = currentPath.replace('index-zh.html', 'index.html');
      }
    }
  }
  
  // Add click event
  langToggle.addEventListener('click', toggleLanguage);
  
  // Make sure language switcher is never hidden by other scripts
  // by periodically checking its visibility
  setInterval(() => {
    const computedStyle = window.getComputedStyle(languageSwitcher);
    
    // If positioned fixed or absolute, reset to proper display
    if (computedStyle.position === 'fixed' || computedStyle.position === 'absolute') {
      languageSwitcher.style.position = 'static';
      languageSwitcher.style.display = 'inline-block';
    }
    
    // If hidden, make visible
    if (computedStyle.display === 'none') {
      languageSwitcher.style.display = 'inline-block';
    }
  }, 1000);
});
</script> 